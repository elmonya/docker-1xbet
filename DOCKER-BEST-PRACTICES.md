# Лучшие практики Docker для проекта 1xBet Aviator

В данном документе описаны лучшие практики Docker, которые были применены в проекте 1xBet Aviator для оптимизации контейнеризации и повышения надёжности и безопасности.

## 1. Основные улучшения

### Использование фиксированных версий образов

Вместо тега `latest` используются конкретные версии образов:
- `mysql:8.0` вместо `mysql:latest`
- `caddy:2.7.4-alpine` вместо `caddy:2`
- `wordpress:6.4-php8.2-apache` вместо `wordpress:latest`

### Многоэтапная сборка (Multi-stage build)

В Dockerfile.wordpress реализована многоэтапная сборка, которая позволяет:
- Уменьшить размер финального образа
- Оптимизировать процесс сборки
- Улучшить безопасность за счет исключения инструментов сборки из финального образа

### Минимизация слоев и размера образов

- Объединение команд RUN с помощью `&&` и `\`
- Очистка кэша пакетного менеджера в том же слое, где установлены пакеты
- Использование Alpine-версий образов, где это возможно

### Использование непривилегированных пользователей

- Запуск Caddy от пользователя `nonroot`
- Правильное установление владельца файлов с помощью `--chown`

### HEALTHCHECK для всех сервисов

Добавлены проверки работоспособности для всех сервисов:
- MySQL: проверка подключения к базе данных
- WordPress: проверка доступности панели администратора
- Caddy: проверка ответа веб-сервера

### Улучшение обработки сигналов

- Правильное использование ENTRYPOINT и CMD
- Корректная обработка сигналов остановки контейнера

## 2. Безопасность

### Секреты и переменные окружения

- Проверка наличия обязательных переменных окружения с использованием синтаксиса `${VAR:?Error message}`
- Установка значений по умолчанию с использованием синтаксиса `${VAR:-default}`
- Генерация случайных паролей, если они не указаны
- Пример файла `.env.example` для иллюстрации необходимых переменных

### Ограничение доступа

- Использование непривилегированных пользователей в контейнерах
- Правильная установка прав доступа к файлам и директориям
- Удаление лишних инструментов и примеров из образов

## 3. Производительность и надежность

### Ограничение ресурсов

В docker-compose.prod.yml:
- Определены лимиты памяти для каждого сервиса
- Определены лимиты CPU для каждого сервиса
- Установлены резервации ресурсов для критических сервисов

### Логирование

- Настроен драйвер логирования `json-file` с ротацией
- Установлены лимиты на размер логов и количество файлов логов
- Улучшено логирование в скриптах с указанием времени и контекста

### Зависимости между сервисами

- Использование `depends_on` с условием `condition: service_healthy`
- Корректная последовательность запуска сервисов
- Проверка доступности базы данных перед запуском WordPress

## 4. Оптимизация разработки

### .dockerignore

Создан файл `.dockerignore` для исключения ненужных файлов из контекста сборки:
- Временные файлы
- Файлы Git
- Логи
- Конфиденциальные данные

### Улучшенный скрипт setup-wordpress.sh

- Добавлена обработка ошибок
- Добавлено логирование с отметками времени
- Улучшена проверка подключения к базе данных
- Добавлен таймаут и количество попыток

### Улучшение docker-compose.prod.yml

- Использование подсети с фиксированным диапазоном IP-адресов
- Определение драйверов для volumes
- Использование `restart: unless-stopped` вместо `restart: always`

## 5. Полезные команды

```bash
# Запуск в production-режиме
docker-compose -f docker-compose.prod.yml up -d

# Проверка статуса контейнеров
docker-compose -f docker-compose.prod.yml ps

# Просмотр логов
docker-compose -f docker-compose.prod.yml logs -f

# Перезапуск отдельного сервиса
docker-compose -f docker-compose.prod.yml restart wordpress

# Сборка и публикация образов
./build-and-push.sh yourusername
```

## 6. Заключение

Применение лучших практик Docker позволяет:
- Повысить безопасность контейнеров
- Улучшить производительность и стабильность
- Сократить время разработки и деплоя
- Облегчить мониторинг и обслуживание

Для дальнейшего улучшения рекомендуется:
- Настроить CI/CD пайплайн для автоматической сборки и тестирования образов
- Реализовать мониторинг с использованием Prometheus и Grafana
- Настроить централизованное логирование с использованием ELK-стека 